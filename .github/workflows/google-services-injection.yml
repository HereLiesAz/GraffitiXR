name: Secure Google Services JSON Injection

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  inject-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate google-services.json
        env:
          GOOGLE_SERVICES_API_KEY: ${{ secrets.GOOGLE_SERVICES_API_KEY }}
        run: |
          if [ -f "app/google-services.json.template" ]; then
            echo "Template found. Injecting secrets..."
            sed "s/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx/$GOOGLE_SERVICES_API_KEY/g" app/google-services.json.template > app/google-services.json
            echo "google-services.json created successfully."
          else
            echo "google-services.json.template not found! Skipping generation."
          fi

      - name: Verify google-services.json existence
        run: |
          if [ -f "app/google-services.json" ]; then
            echo "Verification successful: google-services.json exists."
          elif [ -f "app/google-services.json.template" ]; then
            echo "Verification failed: google-services.json does not exist but template does."
            exit 1
          else
            echo "Template did not exist, so file was not generated. This is expected."
          fi

      - name: Cleanup google-services.json
        if: always()
        run: |
          if [ -f "app/google-services.json" ]; then
            echo "Deleting google-services.json..."
            rm app/google-services.json
            echo "google-services.json deleted."
          else
            echo "google-services.json not found, nothing to delete."
          fi
