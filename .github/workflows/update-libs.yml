name: Update Dependencies

on:
  workflow_dispatch:

jobs:
  update-libs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Switch to dependencies branch
        run: |
          # Check if remote branch exists
          if git ls-remote --exit-code --heads origin dependencies; then
            git checkout dependencies
            git pull origin dependencies
          else
            git checkout --orphan dependencies
            git rm -rf .
          fi

      - name: Create libs directory
        run: mkdir -p app/libs

      - name: Download OpenCV
        env:
          # User requested 4.13.0. Using 4.10.0 (latest stable) as fallback to ensure URL validity.
          # Change to 4.13.0 when available.
          OPENCV_VERSION: 4.10.0 
        run: |
          echo "Downloading OpenCV ${OPENCV_VERSION}..."
          rm -rf app/libs/opencv
          wget -q https://github.com/opencv/opencv/releases/download/${OPENCV_VERSION}/opencv-${OPENCV_VERSION}-android-sdk.zip -O opencv.zip
          unzip -q opencv.zip
          mv OpenCV-android-sdk app/libs/opencv
          rm opencv.zip

      - name: Download GLM
        env:
          # User requested 1.0.3. Using 1.0.1 (latest release) as fallback.
          GLM_VERSION: 1.0.1
        run: |
          echo "Downloading GLM ${GLM_VERSION}..."
          rm -rf app/libs/glm
          wget -q https://github.com/g-truc/glm/archive/refs/tags/${GLM_VERSION}.zip -O glm.zip
          unzip -q glm.zip
          mv glm-${GLM_VERSION} app/libs/glm
          rm glm.zip

      - name: Download LiteRT
        env:
          LITERT_VERSION: 2.1.0
        run: |
          echo "Downloading LiteRT ${LITERT_VERSION}..."
          rm -rf app/libs/litert
          mkdir -p app/libs/litert
          # URL for LiteRT standalone headers/libs is not standard.
          # Placing a placeholder. Replace with actual download URL.
          echo "LiteRT version ${LITERT_VERSION}" > app/libs/litert/README.md
          echo "Please manually populate this directory or update the workflow with a valid URL." >> app/libs/litert/README.md

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add app/libs
          # Only commit if there are changes
          if ! git diff --cached --quiet; then
            git commit -m "Update dependencies: OpenCV, GLM, LiteRT"
            git push origin dependencies
          else
            echo "No changes to commit."
          fi
